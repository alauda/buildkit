apiVersion: builds.katanomi.dev/v1alpha1
kind: Build
spec:
  workspaces:
    - description: |
        This workspace is shared among all the pipeline tasks to read/write common resources
      name: source
  tasks:
    - name: buildkit-oss-version
      workspaces:
        - name: source
          workspace: source
      taskSpec:
        description: |
          generate oss version
        results:
          - description: oss version
            name: oss-version
        steps:
          - image: build-harbor.alauda.cn/devops/builder-tools:alpine-v3.8.0
            name: read-oss-file
            imagePullPolicy: IfNotPresent
            workingDir: $(workspaces.source.path)
            resources:
              requests:
                cpu: 100m
                memory: 100Mi
            script: |
              echo "generate oss version"
              echo -n "$(cat ./buildkit_version| xargs echo -e)"
              echo -n "$(cat ./buildkit_version| xargs echo -e)" > $(results.oss-version.path)
        workspaces:
          - name: source
            workspace: source
    - name: build-buildkit-image
      runAfter:
        - buildkit-oss-version
      timeout: 30m
      retries: 0
      taskRef:
        kind: ClusterTask
        name: alauda-build-image
      workspaces:
        - name: source
          workspace: source
      params:
        - name: container-image
          value: build-harbor.alauda.cn/devops/buildkit
        - name: container-image-tag
          value: $(tasks.buildkit-oss-version.results.oss-version)-alpine-$(build.git.lastCommit.shortID)
        - name: dockerfile
          value: Dockerfile
        - name: labels
          value:
            - branch=$(build.git.branch)
            - commit=$(build.git.lastCommit.id)
        - name: build-extra-args
          value: --build-arg app_version=$(build.git.version.docker) --build-arg
            commit_id=$(build.git.lastCommit.id) --build-arg GIT_REVISION=$(build.git.lastCommit.id) --build-arg GIT_VERSION=$(build.git.version.docker)
        - name: platform
          value:
            - linux/amd64
            - linux/arm64
        - name: tools-image
          value: registry.alauda.cn:60080/devops/builder-tools:v3.8-0-g377a3f9
        - name: verbose
          value: "false"
    - name: image-scan
      runAfter:
        - build-buildkit-image
      timeout: 30m
      retries: 0
      taskRef:
        kind: ClusterTask
        name: trivy-image-scan
      workspaces:
        - name: source
          workspace: source
      when: []
      params:
        - name: targets
          value:
            - $(tasks.build-buildkit-image.results.ociContainerImageBuild-url)
        - name: quality-gate
          value: "false"
  runTemplate:
    spec:
      taskRunSpecs: []
